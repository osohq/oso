{{ $dynPath := .Params.dynPath }}
{{ $path := .Params.path }}
{{ $content := .Params.fallback }}
{{ $syntax := "" }}
{{ $syntaxoverride := .Params.syntax }}
{{ $id := "" }}
{{ $file := "" }}
{{ $hlOpts := .Params.hlOpts | default "" }}

{{ if $path }}
  {{ if $dynPath }}
    {{ errorf "[%v] Cannot specify 'path' and 'dynPath'. \n\t%v" $.Page.Language.LanguageName .Position }}
  {{ else if $content }}
    {{ errorf "[%v] Specifying 'fallback' not allowed when 'path' is present. \n\t%v" $.Page.Language.LanguageName .Position }}
  {{ end }}
{{ else if $dynPath }}
  {{ with $.Page.Resources.GetMatch "data/data.md" }}
    {{ with (index .Params $dynPath) }}
      {{ $path = . }}
    {{ else }}
      {{ if $content }}
      {{ else }}
        {{ errorf "[%v] Missing entry '%v' in data/data.md file with no 'fallback' specified. \n\t%v" $.Page.Language.LanguageName $dynPath .Position }}
      {{ end }}
    {{ end }}
  {{ else }}
    {{ if (eq $.Page.Language.Lang "any") }}
      {{ if .Params.any }}
        {{ errorf "[%v] Missing data/data.md file. \n\t%v" $.Page.Language.LanguageName .Position }}
      {{ else if (and (not (isset .Params "any")) (ne .Parent nil)) }}
        {{ if .Parent.Params.any }}
          {{ errorf "[%v] Missing data/data.md file. \n\t%v" $.Page.Language.LanguageName .Position }}
        {{ end }}
      {{ end }}
    {{ else }}
      {{ errorf "[%v] Missing data/data.md file. \n\t%v" $.Page.Language.LanguageName .Position }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $path }}
{{ else if $content }}
  {{ with $.Page.Resources.GetMatch "data/data.md" }}
    {{ with (index .Params $content) }}
      {{ $content = . }}
    {{ else }}
      {{ errorf "[%v] Missing fallback entry '%v' in data/data.md file. \n\t%v" $.Page.Language.LanguageName $content $.Position }}
    {{ end }}
  {{ else }}
    {{ if (eq $.Page.Language.Lang "any") }}
      {{ if .Params.any }}
        {{ errorf "[%v] Missing data/data.md file. \n\t%v" $.Page.Language.LanguageName .Position }}
      {{ else if (and (not (isset .Params "any")) (ne .Parent nil)) }}
        {{ if .Parent.Params.any }}
          {{ errorf "[%v] Missing data/data.md file. \n\t%v" $.Page.Language.LanguageName .Position }}
        {{ end }}
      {{ end }}
    {{ else }}
      {{ errorf "[%v] Missing data/data.md file. \n\t%v" $.Page.Language.LanguageName .Position }}
    {{ end }}
  {{ end }}
{{ else }}
  {{ errorf "[%v] What u doin' here w/ no 'fallback'?" $.Page.Language.LanguageName }}
{{ end }}

{{ if $path }}
  {{ $file = (index (split $path "/" | last 1) 0) }}
  {{ $id = printf "%s-%s" $file .Ordinal }}

  {{ $syntax = (index (split $file "." | last 1) 0) }}

  {{ $from := .Params.from }}
  {{ $firstLine := 0 }}
  {{ $to := .Params.to }}
  {{ $length := 0 }}
  {{ $content = readFile $path }}

  {{ with $content }}
    {{ with split . "\n" }}
      {{/* Default the snippet length to the file length. */}}
      {{ $length = len . }}

      {{/* Find snippet boundaries if valid values were provided for 'from' and/or 'to'. */}}
      {{ range $index, $line := . }}
        {{ if in $line $from }}
          {{ $firstLine = add $index 1 }}
        {{ else if in $line $to }}
          {{ $length = sub $index $firstLine }}
        {{ end }}
      {{ end }}

      {{/* Trim snippet to boundaries. */}}
      {{ with first $length (after $firstLine .) }}
        {{ $content = (delimit . "\n") }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if (not $syntax) }}
  {{ $syntax = $.Page.Language.Lang }}
{{ end }}

{{ with $syntaxoverride }}
  {{ $syntax = $syntaxoverride }}
{{ end }}

<div class="code" id="{{ $id | urlize }}">
  <div class="filename rounded-t-md bg-gray-200 text-gray-700 text-sm py-2">
    {{ with $syntax }}
      <span class="px-2">
        {{ partialCached "fontawesome.html" . . }}
      </span>
    {{ end }}
    {{ $file }}
  </div>
  {{ with $syntax }}
    {{- highlight $content . $hlOpts -}}
  {{ else }}
    <pre><code>
      {{- $content -}}
    </code></pre>
  {{ end }}
</div>
